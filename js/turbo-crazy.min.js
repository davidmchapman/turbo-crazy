import{Ball}from"./ball.js?v=1.1";import{Path}from"./path.js?v=1.1";import{PathNode}from"./path-node.js?v=1.1";import{Vector}from"./vector.js?v=1.1";let c,ctx,cRect,bgSlider,secondsPassed,oldTimestamp,fps,bgValue,paths=new Map,ballColor=[247,37,133,1],showPath=!0,activePath=-1;function checkKey(e){switch(e.preventDefault(),e.keyCode){case 32:let path=paths.get(activePath),ball=new Ball(4,ballColor),found=!1;for(let i=0;i<path.balls.length;i++)0===path.balls[i].pathNodeIndex&&(found=!0,path.balls[i].equals(ball)||(path.balls[i]=ball));found||path.balls.push(ball);break;case 72:showPath=!showPath;break;case 48:document.getElementById("path-10").click();break;case 49:document.getElementById("path-1").click();break;case 50:document.getElementById("path-2").click();break;case 51:document.getElementById("path-3").click();break;case 52:document.getElementById("path-4").click();break;case 53:document.getElementById("path-5").click();break;case 54:document.getElementById("path-6").click();break;case 55:document.getElementById("path-7").click();break;case 56:document.getElementById("path-8").click();break;case 57:document.getElementById("path-9").click()}return!1}function switchActivePath(e){window.getSelection().removeAllRanges();let pathNumber=parseInt(e.currentTarget.id.split("-")[1]),clickedElement=e.target;if(activePath===pathNumber)return;activePath=pathNumber;let pathDivs=document.getElementsByClassName("path");for(let div of pathDivs)div.classList.remove("selected-path");let pathToggleSpans=document.getElementsByClassName("path-toggle");for(let span of pathToggleSpans)span.style.display="none";let parentPathDiv=document.getElementById("path-"+activePath);parentPathDiv.classList.add("selected-path");let pathEditor=document.getElementById("path-editor"),toggleSpan=parentPathDiv.querySelector(".path-toggle");toggleSpan.style.display="inline-block","none"===pathEditor.style.display?toggleSpan.innerHTML=">":toggleSpan.innerHTML="<"}function canvasClicked(e){let x=e.clientX+window.scrollX-Math.round(cRect.x)-1,y=e.clientY+window.scrollY-Math.round(cRect.y)-3,path=paths.get(activePath);path.redo=[],addToNodes(path,x,y)}function bgSliderInput(e){bgValue=e.target.value}function gameLoop(timestamp){secondsPassed=(timestamp-oldTimestamp)/1e3,oldTimestamp=timestamp,fps=Math.round(1/secondsPassed),draw(),window.requestAnimationFrame(gameLoop)}function addToNodes(path,x,y){let priorNode=path.nodes.at(-1);if(void 0===priorNode)return void path.nodes.push(new PathNode(x,y,!0));let priorNodeVector=new Vector(priorNode.x,priorNode.y),newNodeVector=new Vector(x,y),distance=Vector.distance(priorNodeVector,newNodeVector),direction=Vector.subtract(newNodeVector,priorNodeVector).normalize(),currentPosition=priorNodeVector.clone();for(;;){if(currentPosition=Vector.multiply(direction,16).add(currentPosition),!(Vector.distance(priorNodeVector,currentPosition)<distance)){path.nodes.push(new PathNode(x,y,!0));break}path.nodes.push(new PathNode(currentPosition.x,currentPosition.y,!1))}}function removeNode(){let path=paths.get(activePath),lastNode=path.nodes.pop();if(path.redo.push(lastNode),path.nodes.length>0)for(;!path.nodes.at(-1).isAnchor;)path.nodes.pop();for(let i=path.balls.length-1;i>=0;i--)path.balls[i].pathNodeIndex>path.nodes.length&&path.balls.splice(i,1)}function undoRemoveNode(){let path=paths.get(activePath),node=path.redo.pop();void 0!==node&&addToNodes(path,node.x,node.y)}function draw(){drawBackground(),drawFps(),drawPaths()}function drawBackground(){ctx.fillStyle="rgb("+bgValue+", "+bgValue+", "+bgValue+")",ctx.fillRect(0,0,c.width,c.height)}function drawFps(){let fpsDiv;document.getElementById("fps").innerHTML="FPS: "+fps}function drawPaths(){for(const[pathNumber,path]of paths)drawPathNodes(pathNumber,path),drawPathBalls(path)}function drawPathNodes(pathNumber,path){let nodeColor=Math.abs(bgValue-255);showPath||(nodeColor=bgValue),ctx.fillStyle="rgb("+nodeColor+", "+nodeColor+", "+nodeColor+")";let maxNodeIndex=path.nodes.length-1;path.nodes.forEach((n,i)=>{if(!n.isAnchor||pathNumber!==activePath)return void ctx.fillRect(n.x,n.y,1,1);let radius=1;pathNumber===activePath&&(radius=4),ctx.beginPath(),ctx.arc(n.x,n.y,radius,0,2*Math.PI),ctx.fill(),maxNodeIndex===i&&(ctx.beginPath(),ctx.arc(n.x,n.y,radius+2,0,2*Math.PI),ctx.fill(),ctx.fillStyle="rgb("+bgValue+", "+bgValue+", "+bgValue+")",ctx.beginPath(),ctx.arc(n.x,n.y,radius,0,2*Math.PI),ctx.fill(),ctx.fillStyle="rgb("+nodeColor+", "+nodeColor+", "+nodeColor+")",ctx.beginPath(),ctx.arc(n.x,n.y,radius-2,0,2*Math.PI),ctx.fill())})}function drawPathBalls(path){let maxNodeIndex=path.nodes.length-1;-1!==maxNodeIndex&&path.balls.forEach(b=>{let newIndex=b.pathNodeIndex>=maxNodeIndex?0:b.pathNodeIndex+1;b.pathNodeIndex=newIndex;let node=path.nodes[newIndex];ctx.beginPath(),ctx.arc(node.x,node.y,6,0,2*Math.PI),ctx.fillStyle="rgba("+b.rgbaArray[0]+", "+b.rgbaArray[1]+", "+b.rgbaArray[2]+", "+b.rgbaArray[3]+")",ctx.fill()})}document.addEventListener("DOMContentLoaded",event=>{window.scrollTo(0,0);let clientWidth=document.body.clientWidth;if(clientWidth<700)return void alert("Please make your browser window wider and reload the page.");c=document.getElementById("canvas"),ctx=c.getContext("2d"),ctx.canvas.width=clientWidth-100,cRect=c.getBoundingClientRect(),bgSlider=document.getElementById("bg-slider"),window.addEventListener("keyup",checkKey),c.addEventListener("click",canvasClicked,!1),bgSlider.addEventListener("input",bgSliderInput,!1),bgValue=bgSlider.value,window.addEventListener("keydown",e=>{32===e.keyCode&&e.target===document.body&&e.preventDefault()});let pathDivs=document.getElementsByClassName("path");for(let div of pathDivs)div.addEventListener("click",switchActivePath);document.getElementById("undo").addEventListener("click",removeNode),document.getElementById("redo").addEventListener("click",undoRemoveNode),document.getElementById("swatch_005f73").addEventListener("click",e=>{ballColor=[0,95,115,1]},!1),document.getElementById("swatch_0a9396").addEventListener("click",e=>{ballColor=[10,147,150,1]},!1),document.getElementById("swatch_94d2bd").addEventListener("click",e=>{ballColor=[148,210,189,1]},!1),document.getElementById("swatch_e9d8a6").addEventListener("click",e=>{ballColor=[233,216,166,1]},!1),document.getElementById("swatch_ee9b00").addEventListener("click",e=>{ballColor=[238,155,0,1]},!1),document.getElementById("swatch_ca6702").addEventListener("click",e=>{ballColor=[202,103,2,1]},!1),document.getElementById("swatch_bb3e03").addEventListener("click",e=>{ballColor=[187,62,3,1]},!1),document.getElementById("swatch_ae2012").addEventListener("click",e=>{ballColor=[174,32,18,1]},!1),document.getElementById("swatch_f72585").addEventListener("click",e=>{ballColor=[247,37,133,1]},!1),document.getElementById("swatch_b5179e").addEventListener("click",e=>{ballColor=[181,23,158,1]},!1),document.getElementById("swatch_7209b7").addEventListener("click",e=>{ballColor=[114,9,183,1]},!1),document.getElementById("swatch_560bad").addEventListener("click",e=>{ballColor=[86,11,173,1]},!1),document.getElementById("swatch_3f37c9").addEventListener("click",e=>{ballColor=[63,55,201,1]},!1),document.getElementById("swatch_4361ee").addEventListener("click",e=>{ballColor=[67,97,238,1]},!1);for(let pathNumber=1;pathNumber<=10;pathNumber++)paths.set(pathNumber,new Path);let pathEditor=document.getElementById("path-editor"),pathToggles=document.getElementsByClassName("path-toggle");for(let pathToggle of pathToggles)pathToggle.addEventListener("click",(function(){"none"===pathEditor.style.display?(pathEditor.style.display="block",pathToggle.innerHTML="<"):(pathEditor.style.display="none",pathToggle.innerHTML=">")}));document.getElementById("path-1").click(),window.requestAnimationFrame(gameLoop)});