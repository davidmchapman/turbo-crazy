import{Ball}from"./ball.js?v=1.5";import{Path}from"./path.js?v=1.6";import{PathNode}from"./path-node.js?v=1.1";import{Vector}from"./vector.js?v=1.1";import{Spark}from"./spark.js";let c,ctx,cRect,bgSlider,secondsPassed,oldTimestamp,fps,bgValue,antiBgValue,paths=new Map,sparks=[],ballColor="#000000",showPath=!0,activePalette=-1,activePath=-1;function checkKey(e){switch(e.preventDefault(),e.code){case"Space":launch();break;case"KeyH":togglePaths();break;case"KeyL":adjustSize(1);break;case"KeyQ":toggleSparks();case"KeyR":undoRemoveNode();break;case"KeyS":adjustSize(-1);break;case"KeyT":toggleTwirl();break;case"KeyU":removeNode();break;case"Digit0":case"Numpad0":document.getElementById("path-10").click();break;case"Digit1":case"Numpad1":document.getElementById("path-1").click();break;case"Digit2":case"Numpad2":document.getElementById("path-2").click();break;case"Digit3":case"Numpad3":document.getElementById("path-3").click();break;case"Digit4":case"Numpad4":document.getElementById("path-4").click();break;case"Digit5":case"Numpad5":document.getElementById("path-5").click();break;case"Digit6":case"Numpad6":document.getElementById("path-6").click();break;case"Digit7":case"Numpad7":document.getElementById("path-7").click();break;case"Digit8":case"Numpad8":document.getElementById("path-8").click();break;case"Digit9":case"Numpad9":document.getElementById("path-9").click();break;case"Minus":case"NumpadSubtract":adjustSpeed(-1);break;case"Equal":case"NumpadAdd":adjustSpeed(1)}return!1}function togglePaths(){showPath=!showPath;let button=document.getElementById("hide-paths-button");button.textContent=showPath?"Hide Paths":"Show Paths"}function launch(){let path=paths.get(activePath),ball=new Ball(path.ballSize,ballColor),found=!1;for(let i=0;i<path.balls.length;i++)0===path.balls[i].pathNodeIndex&&(found=!0,path.balls[i].equals(ball)||(path.balls[i]=ball));found||path.balls.push(ball)}function toggleTwirl(){let path=paths.get(activePath);path.isTwirling=!path.isTwirling}function toggleSparks(){let path=paths.get(activePath);path.isSparking=!path.isSparking}function reduceSize(){adjustSize(-1)}function increaseSize(){adjustSize(1)}function adjustSize(adjustment){let path;window.getSelection().removeAllRanges(),paths.get(activePath).adjustSize(adjustment)}function reduceSpeed(){adjustSpeed(-1)}function increaseSpeed(){adjustSpeed(1)}function adjustSpeed(adjustment){let path;window.getSelection().removeAllRanges(),paths.get(activePath).adjustSpeed(adjustment)}function switchPalette(e){window.getSelection().removeAllRanges();let paletteNumber=parseInt(e.currentTarget.id.split("-")[1]);if(paletteNumber!==activePalette){switch(paletteNumber){case 1:buildSwatches(["#FFF0F3","#FFCCD5","#FFB3C1","#FF8FA3","#FF758F","#FF4D6D","#C9184A","#A4133C","#800F2F","#590D22"]);break;case 2:buildSwatches(["#F8F9FA","#E9ECEF","#DEE2E6","#CED4DA","#ADB5BD","#6C757D","#495057","#343A40","#212529"]);break;case 3:buildSwatches(["#80FFDB","#72EFDD","#64DFDF","#56CFE1","#48BFE3","#4EA8DE","#5390D9","#5E60CE","#6930C3","#7400B8"]);break;case 4:buildSwatches(["#FFFFFC","#FFC6FF","#BDB2FF","#A0C4FF","#9BF6FF","#CAFFBF","#FDFFB6","#FFD6A5","#FFADAD"]);break;case 5:buildSwatches(["#FFBA08","#FAA307","#F48C06","#E85D04","#DC2F02","#D00000","#9D0208","#6A040F","#370617","#03071E"]);break;case 6:buildSwatches(["#E63946","#F1FAEE","#A8DADC","#457B9D","#1D3557"]);break;case 7:buildSwatches(["#FF0000","#FF8700","#FFD300","#DEFF0A","#A1FF0A","#0AFF99","#0AEFFF","#147DF5","#580AFF","#BE0AFF"]);break;case 8:buildSwatches(["#CCFF33","#9EF01A","#70E000","#38B000","#008000","#007200","#006400","#004B23"]);break;case 9:buildSwatches(["#E0AAFF","#C77DFF","#9D4EDD","#7B2CBF","#5A189A","#3C096C","#240046","#10002B"]);break;case 10:buildSwatches(["#FF595E","#FFCA3A","#8AC926","#1982C4","#6A4C93"]);break;case 11:buildSwatches(["#E3F2FD","#BBDEFB","#90CAF9","#64B5F6","#42A5F5","#2196F3","#1E88E5","#1976D2","#1565C0","#0D47A1"]);break;case 12:buildSwatches(["#FFEA00","#FFDD00","#FFD000","#FFC300","#FFB700","#FFAA00","#FFA200","#FF9500","#FF8800","#FF7B00"]);break;case 13:buildSwatches(["#EDC4B3","#E6B8A2","#DEAB90","#D69F7E","#CD9777","#C38E70","#B07D62","#9D6B53","#8A5A44","#774936"]);break;case 14:buildSwatches(["#000000"])}document.getElementById("swatch-1").click()}}function buildSwatches(colors){let maxIndex=colors.length;for(let i=1;i<=12;i++){let swatch=document.getElementById("swatch-"+i);swatch.style.borderColor="transparent",swatch.style.backgroundColor="transparent",i-1<maxIndex&&(swatch.style.backgroundColor=colors[i-1])}}function switchColor(e){let swatchNumber=parseInt(e.currentTarget.id.split("-")[1]),clickedSwatch=document.getElementById("swatch-"+swatchNumber);if("transparent"===clickedSwatch.style.backgroundColor)return;let swatches=document.getElementsByClassName("swatch");for(let swatch of swatches)swatch.style.borderColor="transparent";ballColor=clickedSwatch.style.backgroundColor,clickedSwatch.style.borderColor="red"}function switchActivePath(e){window.getSelection().removeAllRanges();let pathNumber=parseInt(e.currentTarget.id.split("-")[1]),clickedElement=e.target;if(activePath===pathNumber)return;activePath=pathNumber;let pathDivs=document.getElementsByClassName("path");for(let div of pathDivs)div.classList.remove("selected-path");let pathToggleSpans=document.getElementsByClassName("path-toggle");for(let span of pathToggleSpans)span.style.display="none";let parentPathDiv=document.getElementById("path-"+activePath);parentPathDiv.classList.add("selected-path");let pathEditor=document.getElementById("path-editor"),toggleSpan=parentPathDiv.querySelector(".path-toggle");toggleSpan.style.display="inline-block","none"===pathEditor.style.display?toggleSpan.innerHTML=">":toggleSpan.innerHTML="<"}function canvasClicked(e){let x=e.clientX+window.scrollX-Math.round(cRect.x)-1,y=e.clientY+window.scrollY-Math.round(cRect.y)-3,path=paths.get(activePath);path.redo=[],addToNodes(path,x,y)}function bgSliderInput(e){bgValue=e.target.value,calculateAntiBgValue(),console.log(bgValue+"   "+antiBgValue)}function gameLoop(timestamp){secondsPassed=(timestamp-oldTimestamp)/1e3,oldTimestamp=timestamp,fps=Math.round(1/secondsPassed),draw(),window.requestAnimationFrame(skipFrame)}function skipFrame(){window.requestAnimationFrame(gameLoop)}function addToNodes(path,x,y){let priorNode=path.nodes.at(-1);if(void 0===priorNode)return void path.nodes.push(new PathNode(x,y,!0));let priorNodeVector=new Vector(priorNode.x,priorNode.y),newNodeVector=new Vector(x,y),distance=Vector.distance(priorNodeVector,newNodeVector),direction=Vector.subtract(newNodeVector,priorNodeVector).normalize(),currentPosition=priorNodeVector.clone();for(;;){if(currentPosition=Vector.multiply(direction,8).add(currentPosition),!(Vector.distance(priorNodeVector,currentPosition)<distance)){path.nodes.push(new PathNode(x,y,!0));break}path.nodes.push(new PathNode(currentPosition.x,currentPosition.y,!1))}}function removeNode(){let path=paths.get(activePath),lastNode=path.nodes.pop();if(void 0!==lastNode){if(path.redo.push(lastNode),path.nodes.length>0)for(;!path.nodes.at(-1).isAnchor;)path.nodes.pop();for(let i=path.balls.length-1;i>=0;i--)path.balls[i].pathNodeIndex>path.nodes.length&&path.balls.splice(i,1)}}function undoRemoveNode(){let path=paths.get(activePath),node=path.redo.pop();void 0!==node&&addToNodes(path,node.x,node.y)}function draw(){drawBackground(),drawFps(),drawPaths(),drawSparks()}function calculateAntiBgValue(){antiBgValue=bgValue>=128?0:255}function drawBackground(){ctx.fillStyle="rgb("+bgValue+", "+bgValue+", "+bgValue+")",ctx.fillRect(0,0,c.width,c.height)}function drawFps(){let fpsDiv;document.getElementById("fps").innerHTML="FPS: "+fps}function drawPaths(){for(const[pathNumber,path]of paths)showPath&&drawPathNodes(pathNumber,path),drawPathBalls(path)}function drawPathNodes(pathNumber,path){let nodeColor=antiBgValue;ctx.fillStyle="rgb("+nodeColor+", "+nodeColor+", "+nodeColor+")";let maxNodeIndex=path.nodes.length-1;path.nodes.forEach((n,i)=>{if(!n.isAnchor||pathNumber!==activePath)return void ctx.fillRect(n.x,n.y,1,1);let radius=1;pathNumber===activePath&&(radius=4),ctx.beginPath(),ctx.arc(n.x,n.y,radius,0,2*Math.PI),ctx.fill(),maxNodeIndex===i&&(ctx.beginPath(),ctx.arc(n.x,n.y,radius+2,0,2*Math.PI),ctx.fill(),ctx.fillStyle="rgb("+bgValue+", "+bgValue+", "+bgValue+")",ctx.beginPath(),ctx.arc(n.x,n.y,radius,0,2*Math.PI),ctx.fill(),ctx.fillStyle="rgb("+nodeColor+", "+nodeColor+", "+nodeColor+")",ctx.beginPath(),ctx.arc(n.x,n.y,radius-2,0,2*Math.PI),ctx.fill())})}function drawPathBalls(path){let maxNodeIndex;-1!==path.nodes.length-1&&path.balls.forEach(b=>{let newIndex=(b.pathNodeIndex+path.speed)%path.nodes.length;newIndex<0&&(newIndex=path.nodes.length+newIndex),b.pathNodeIndex=newIndex;let node=path.nodes[newIndex],[offsetX,offsetY]=twirlingOffset(path,node,b);ctx.beginPath(),ctx.arc(offsetX,offsetY,b.size,0,2*Math.PI),ctx.fillStyle=b.rgbColor,ctx.fill(),path.isSparking&&Math.random()<.05&&sparks.push(...Spark.generate(offsetX,offsetY,14,10,b.rgbColor,.1,10))})}function drawSparks(){let sparksToRemove=[];sparks.forEach((s,i)=>{if(s.opacity>0){const[point1,point2]=s.getEndpoints();ctx.globalAlpha=s.opacity,ctx.strokeStyle=s.rgbColor,ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(point1.x,point1.y),ctx.lineTo(point2.x,point2.y),ctx.stroke()}else sparksToRemove.push(i)});for(let i=sparksToRemove.length-1;i>=0;i--)sparks.splice(i,1);ctx.globalAlpha=1}function twirlingOffset(path,node,ball){if(!path.isTwirling)return[node.x,node.y];let x,y;return ball.updateTwirlAngle(),[node.x+15*Math.cos(ball.twirlAngle),node.y+15*Math.sin(ball.twirlAngle)]}document.addEventListener("DOMContentLoaded",event=>{window.scrollTo(0,0);let clientWidth=document.body.clientWidth;if(clientWidth<400)return void alert("Please make your browser window wider and reload the page.");c=document.getElementById("canvas"),ctx=c.getContext("2d"),ctx.canvas.width=clientWidth-100,cRect=c.getBoundingClientRect(),bgSlider=document.getElementById("bg-slider"),window.addEventListener("keyup",checkKey),c.addEventListener("click",canvasClicked,!1),bgSlider.addEventListener("input",bgSliderInput,!1),bgValue=bgSlider.value,calculateAntiBgValue(),window.addEventListener("keydown",e=>{32===e.keyCode&&e.target===document.body&&e.preventDefault()});let pathDivs=document.getElementsByClassName("path");for(let div of pathDivs)div.addEventListener("click",switchActivePath);document.getElementById("undo").addEventListener("click",removeNode),document.getElementById("redo").addEventListener("click",undoRemoveNode);let palettes=document.getElementsByClassName("palette");for(let palette of palettes)palette.addEventListener("click",switchPalette);let swatches=document.getElementsByClassName("swatch");for(let swatch of swatches)swatch.addEventListener("click",switchColor);for(let pathNumber=1;pathNumber<=10;pathNumber++)paths.set(pathNumber,new Path);let pathEditor=document.getElementById("path-editor"),pathToggles=document.getElementsByClassName("path-toggle");for(let pathToggle of pathToggles)pathToggle.addEventListener("click",(function(){"none"===pathEditor.style.display?(pathEditor.style.display="block",pathToggle.innerHTML="<"):(pathEditor.style.display="none",pathToggle.innerHTML=">")}));document.getElementById("ball-slower").addEventListener("click",reduceSpeed),document.getElementById("ball-faster").addEventListener("click",increaseSpeed),document.getElementById("ball-smaller").addEventListener("click",reduceSize),document.getElementById("ball-larger").addEventListener("click",increaseSize),document.getElementById("twirly").addEventListener("click",toggleTwirl),document.getElementById("hide-paths-button").addEventListener("click",togglePaths),document.getElementById("launch-button").addEventListener("click",launch),document.getElementById("palette-12").click(),document.getElementById("path-1").click(),window.requestAnimationFrame(gameLoop)});